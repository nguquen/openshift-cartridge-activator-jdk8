#!/bin/bash -e

case "$1" in
  -v|--version)
    version="$2"
esac

function setup-jdk-8() {
  echo "Downloading and Configuring Java 8"
  if [ ! -d "${OPENSHIFT_ACTIVATOR_DIR}/jdk" ]; then
    mkdir -p ${OPENSHIFT_ACTIVATOR_DIR}/jdk
  fi

  if [ ! -d "${OPENSHIFT_ACTIVATOR_DIR}/jdk/jdk1.8.0_60" ]; then
    pushd ${OPENSHIFT_ACTIVATOR_DIR}/jdk
    wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u60-b27/jdk-8u60-linux-x64.tar.gz
    tar -zxf jdk-8u60-linux-x64.tar.gz
    rm jdk-8u60-linux-x64.tar.gz
    popd
  fi
  echo "Java 8 Downloaded"
}

function build {
    echo "building"
    cd $OPENSHIFT_REPO_DIR
    activator clean stage -Duser.home=${OPENSHIFT_DATA_DIR} -mem 384
}

# create logs dir
if [ ! -d "${OPENSHIFT_ACTIVATOR_DIR}/logs" ]; then
    mkdir -p ${OPENSHIFT_ACTIVATOR_DIR}/logs
fi

# setup jdk 8
# setup-jdk-8

# set env variables
export ACTIVATOR_HOME="$OPENSHIFT_ACTIVATOR_DIR/versions/${version}"
export JAVA_HOME="$OPENSHIFT_ACTIVATOR_DIR/jdk/jdk1.8.0_60"
export PATH="$JAVA_HOME/bin:$ACTIVATOR_HOME:$PATH"
echo $JAVA_HOME > $OPENSHIFT_ACTIVATOR_DIR/env/JAVA_HOME
echo $ACTIVATOR_HOME > $OPENSHIFT_ACTIVATOR_DIR/env/ACTIVATOR_HOME
echo "$JAVA_HOME/bin:$ACTIVATOR_HOME" > $OPENSHIFT_ACTIVATOR_DIR/env/OPENSHIFT_ACTIVATOR_PATH_ELEMENT

export JAVA_OPTS="-Xmx384M -Xms384M -XX:+UseCompressedOops -XX:MetaspaceSize=64m -XX:MaxMetaspaceSize=128m"
build